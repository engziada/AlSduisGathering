<!DOCTYPE html>
{% extends 'base.html' %}

{% block title %}لوحة التحكم - أسرة السديس{% endblock %}

{% block content %}
    {% include 'includes/logout_button.html' %}
    {% include 'includes/admin_navbar.html' %}
    
    <h1 class="col">صفحة مدير النظام</h1>
    <hr>

    <div class="border border-1 text-center px-5">
        <div class="row pt-3">
            <div class="col-md-4">
                    <p>مجموع الضيوف: {{guests_count}}</p>
            </div>
            <div class="col-md-4">
                    <p>الضيوف الذكور: {{guest_male}}</p>
            </div>
            <div class="col-md-4">
                    <p>الضيوف الإناث: {{guest_female}}</p>
            </div>
        </div>

        <hr class="p-0 m-0">

        <div class="row pt-3">
            <div class="col-md-4">
                    <p>تأكيد الحضور: {{guest_attendance}}</p>
            </div>
            <div class="col-md-4">
                    <p>تأكيد عدم الحضور: {{guest_not_attendance}}</p>
            </div>
            <div class="col-md-4">
                    <p>الضيوف الحاضرون: {{guest_is_attended}}</p>
            </div>
        </div>

        <hr class="p-0 m-0">

        <div class="row pt-3 pb-3">
            <div class="col-md-4">
                    <p>مجموع الأطفال: {{children_count}}</p>
            </div>
            <div class="col-md-4">
                    <p>الأطفال الذكور: {{children_male}}</p>
            </div>
            <div class="col-md-4">
                    <p>الأطفال الإناث: {{children_female}}</p>
            </div>
        </div>
    </div>

    <div class="border border-2 rounded p-3 mb-4" style="border-color: #085E9D !important;">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('export_to_excel') }}" class="btn btn-outline-primary">
                <i class="fas fa-file-excel me-2"></i>
                تصدير البيانات
            </a>
            
            <div class="btn-group">
                <a href="{{ url_for('backup_db') }}" class="btn btn-outline-success">
                    <i class="fas fa-download me-2"></i>
                    حفظ نسخة إحتياطية
                </a>
                
                <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_file') }}" class="d-inline">
                    <button type="button" class="btn btn-outline-warning" onclick="document.getElementById('file-upload').click();">
                        <i class="fas fa-upload me-2"></i>
                        إستعادة نسخة إحتياطية
                    </button>
                    <input type="file" name="file" id="file-upload" accept=".db" style="display: none;" onchange="confirmRestore(this);">
                </form>

                <button type="button" class="btn btn-outline-danger" onclick="confirmClearData()">
                    <i class="fas fa-trash-alt me-2"></i>
                    مسح جميع البيانات
                </button>
            </div>
        </div>
    </div>  

    <div>
        <form action="{{ url_for('admin') }}" method="post" class="py-3">
            {{ form.hidden_tag() }}
            <div class="row">
                {%if close_registrations%}
                <button type="submit" class="col btn btn-danger mx-5" name="reg_status_form">التسجيل الان مغلق .. إضغط لإتاحة التسجيل</button>
                {%else%}
                <button type="submit" class="col btn btn-success mx-5" name="reg_status_form">التسجيل الان متاح .. إضغط لإغلاق التسجيل</button>
                {%endif%}
            </div>
        </form>
    </div>

    <div class="table-responsive mt-4">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="border border-1">مسلسل</th>
                    <th colspan="7">الإسم بالكامل</th>
                <tr>
                    <th>رقم الجوال</th>
                    <th>رقم التسجيل</th>
                    <th>صلة القرابة</th>
                    <th>السن</th>
                    <th>الجنس</th>
                    <th>المدينة</th>
                    <th>تأكيد الحضور</th>
                    <th>تم حضوره</th>
                    <th></th>              
                </tr>
                <tr>
                    <th>فاز بجائزة</th>
                    <th>اسم الجائزة</th>
                </tr>
            </thead>
            <tbody>
                {% for guest in guests.items %}
                <tr>
                    <td class="border border-1">{{ loop.index }}</td>
                    <td colspan="7">{{ guest.first_name }} {{ guest.father_name }} {{ guest.first_grand_name }} {{ guest.second_grand_name }} {{ guest.third_grand_name }} {{ guest.family_name }}</td>
                    <td class="border border-1 text-center" rowspan="2">
                        <a class="text-danger" href="{{ url_for('delete_guest', guest_phoneno=guest.phone_number) }}" onclick="return confirm('هل أنت متأكد من الحذف؟')">حذف
                            <span class="material-symbols-outlined">delete</span>
                        </a>
                    </td>
                </tr>

                <tr>
                    <td>{{ guest.phone_number }}</td>
                    <td>{{ guest.registration_number }}</td>
                    <td>{{ guest.relation }}</td>
                    <td>{{ guest.age|replace('سنة', '') }}</td>
                    <td>{{ guest.gender }}</td>
                    <td>{{ guest.city }}</td>
                    <td>{% if guest.attendance=='سوف أحضر باذن الله' %}نعم{% else %}أعتذر{%endif%}</td>
                    <td>{% if guest.is_attended %}حضر{% else %}لم يحضر{%endif%}</td>
                </tr>
                <tr>
                    <td>{% if guest.prize_id %}نعم{% else %}لا{%endif%}</td>
                    <td>{% if guest.prize_id %}{{ guest.prize.name }}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination controls -->
    <div class="pagination">
        {% if guests.has_prev %}
                <a href="{{ url_for('admin', page=1) }}">
                    <span class="material-symbols-outlined">keyboard_double_arrow_right</span>
                </a>

            <a href="{{ url_for('admin', page=guests.prev_num) }}">
                <span class="material-symbols-outlined">chevron_right</span>
            </a>
        {% endif %}
        <span>{{ guests.page }} من {{ guests.pages }}</span>
        {% if guests.has_next %}
            <a href="{{ url_for('admin', page=guests.next_num) }}">
                <span class="material-symbols-outlined">chevron_left</span>
            </a>

            <a href="{{ url_for('admin', page=guests.pages) }}">
                <span class="material-symbols-outlined">keyboard_double_arrow_left</span>
            </a>
        {% endif %}
    </div>
    <br>

{% endblock %}

{% block scripts %}
<script>
function confirmRestore(input) {
    if (input.files.length > 0) {
        if (confirm('هل أنت متأكد من إستعادة النسخة الإحتياطية؟ سيتم إستبدال جميع البيانات الحالية')) {
            input.form.submit();
        }
    }
}

function confirmClearData() {
    if (confirm('هل أنت متأكد من مسح جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء')) {
        window.location.href = "{{ url_for('clear_all_data') }}";
    }
}
</script>
{% endblock %}
