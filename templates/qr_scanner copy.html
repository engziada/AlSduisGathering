{% extends 'master.html' %}

{% block title %}QR Code Scanner{% endblock %}

{% block content %}
    <h1>Scan QR Code</h1>
    <div id="scanner-container"></div>
{% endblock %}

{% block scripts%}
<script src="https://cdn.rawgit.com/serratus/quaggaJS/0.12.1/dist/quagga.min.js"></script>
<script>
    // Check if the browser supports the getUserMedia API
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Request permission to access the camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                // User has granted permission
                alert('Camera access granted');
                
                // Now you can use the camera stream, or stop it if not needed
                // stream.getTracks().forEach(track => track.stop());
            })
            .catch(function(error) {
                // Permission denied or error occurred
                alert('Error accessing camera:', error);
            });
    } else {
        // Browser does not support getUserMedia
        alert('getUserMedia is not supported in this browser');
    }


    // JavaScript code for QR code scanning using QuaggaJS
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector("#scanner-container"),
            constraints: {
                width: 480,
                height: 320,
                facingMode: "environment", // Use the rear camera (you can change this based on your requirements)
            },
        },
        locator: {
            patchSize: "medium",
            halfSample: true,
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        decoder: {
            readers: ["ean_reader"], // Change the reader based on your QR code type
        },
        locate: true,
    }, function (err) {
        if (err) {
            console.error(err);
            return;
        }
        console.log("Initialization finished. Ready to start");
        Quagga.start();
    });

    Quagga.onDetected(function (result) {
        // Handle the detected QR code result
        const code = result.codeResult.code;
        alert("QR Code Scanned: " + code);
        // You can use the scanned code as needed (e.g., redirect to a specific page)
        // window.location.href = "/process_qr?code=" + code;
    });
</script>
{% endblock %}