{% extends 'master.html' %}

{% block content %}

<!-- Add confetti elements to the HTML with a hidden class initially -->
<div id="confettiContainer" style="display: flex; flex-direction: row; justify-content: space-between;">
</div>

  <h2>السحب العشوائي</h2>
  <div id="prize_box" class="border border-success p-2 m-5 font-weight-bold shadow text-center" style="border-radius: 5px">
    <h5>الجائزة التي سيتم السحب عليها هي</h5>
    <h1>{{prize.name}}</h1>
    <h2>{{prize.description}}</h2>
    <span id="prizeid_span" style="display: none;">{{prize.id}}</span>
  </div>

    <!-- randomize -->
<div class="slot-machine-body my-5" id="slotmachine">
  <div class="slot-machine">
    <div class="ul" id="slot1">
    </div>
  </div>
</div>
<div class="text-center" style="width: 100%;">
  <button class="btn btn-primary text-center" id="startButton">إبدأ</button>
</div>
  <div class="border border-success p-2 m-5 font-weight-bold shadow text-center" id="hiddenDiv" style="border-radius: 5px; display:none">
    <h2 id="winner_name_box"></h2>
    <div class="text-left">
      <button class="btn btn-success" id="confirmButton">تأكيد</button>
    </div>
  </div>
  
  <a href="{{ url_for('list_prizes') }}" class="btn btn-secondary mt-3">العودة لصفحة الهدايا</a>
{% endblock %}

{% block scripts%}
<script>
  var winnername;
  var winnerno;
  var prizeId = document.getElementById('prizeid_span').textContent.trim();

    document.addEventListener('animationend', function(event) {
      if (event.animationName === 'confetti-fall') {
        event.target.style.display = 'none';
      }
    });

  document.getElementById('startButton').addEventListener('click', function() {
        var slotmachine=document.getElementById('slot1');
        //var winner_name_box=document.getElementById('winner_name');
        var hiddenDiv = document.getElementById('hiddenDiv'); // Assuming you have a hidden div with this ID
        var confettiContainer = document.getElementById('confettiContainer'); // Assuming you have a container for confetti

        // Add confetti elements dynamically
        confettiContainer.innerHTML = ''; // Clear existing confetti elements
        for (let i = 0; i < 20; i++) { // Add as many confetti elements as needed
          const confetti = document.createElement('div');
          confetti.className = 'confetti hidden-confetti';
          confetti.style.animationDuration = Math.random() * 2 + 's'; // Randomize animation duration
          confetti.style.animationDelay = Math.random() + 's'; // Randomize animation delay
          confetti.style.transform = 'rotate(' + Math.random() * 360 + 'deg)'; // Randomize initial rotation
          confettiContainer.appendChild(confetti);
        };
        var confetti = $('.confetti'); // Use jQuery selector to get the confetti elements

        // Fetch the updated list from the server
        $.ajax({
          url: `/shuffle_numbers/${prizeId}`,
          type: 'GET',
          dataType: 'json',
          success: function(data) {
            var regno_list=data.regno_list;
            winnerno=data.winner;
            winnername=data.winner_name;

            // Clear existing slots before appending new ones
            slotmachine.innerHTML = '';
            hiddenDiv.style.display = 'none';

            regno_list.forEach((result, index) => {
              const newDiv = document.createElement('div');
              newDiv.className = 'slot';
              newDiv.textContent = result;
              slotmachine.appendChild(newDiv);
            });
    
            $('#winner_name_box').text(winnername);
    
            // Reset
            slotmachine.classList.remove('play');
            void slotmachine.offsetWidth;  // Trigger reflow to restart the animation
            slotmachine.classList.add('play');       
            
            // Add an event listener for animation end
            slotmachine.addEventListener('animationend', function() {
              // Show the hidden div after the animation ends
              hiddenDiv.style.display = 'block';
              confetti.removeClass('hidden-confetti');

            });
            
          },
          error: function(error) {
            console.error('Error fetching updated list:', error);
          }
        });
  });

  document.getElementById('confirmButton').addEventListener('click', function() {
    var prizebox=document.getElementById('prize_box');
    var hiddenDiv = document.getElementById('hiddenDiv'); // Assuming you have a hidden div with this ID
    // Send 'prize id' and 'reg id' to Python function using another AJAX request
    $.ajax({
      url: `/confirm_prize/${prizeId}/${winnerno}`, // Include 'prize id' and 'reg id' in the URL
      type: 'POST', // Use POST or GET based on your server setup
      dataType: 'json',
      success: function(response) {
        prizebox.innerHTML = `
        <h3>تم تأكيد الفائز بنجاح</h3>
        <h2>مبروك</h2>
        <h1>${winnername}</h1>
        <h2>هديتك</h2>
        <h1>{{prize.name}}</h1>`;
        //window.location.href = '/withdraw_prize'; // Replace with the actual URL of the 'prize list' page
        hiddenDiv.style.display = 'none';
      },
      error: function(error) {
        console.error('Error confirming prize:', error);
      }
    });
  });
</script>
{% endblock %}